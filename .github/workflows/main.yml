name: ğŸ§€ æ‰“åŒ…æ‰€æœ‰å¹³å°

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¨é€ tag æ—¶è§¦å‘
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        include:
          # Windows 64ä½
          - os: windows-latest
            platform: win64
            artifact_name: CheeseCloudTools-Windows-x64
          
          # Windows 32ä½ (ä½¿ç”¨ 32ä½ Python)
          # - os: windows-latest
          #   platform: win32
          #   artifact_name: CheeseCloudTools-Windows-x86
          #   python_arch: x86
          
          # macOS Intel
          - os: macos-13
            platform: mac_x64
            artifact_name: CheeseCloudTools-macOS-Intel
          
          # macOS Apple Silicon
          - os: macos-latest
            platform: mac_arm64
            artifact_name: CheeseCloudTools-macOS-AppleSilicon
          
          # Linux 64ä½
          - os: ubuntu-latest
            platform: linux64
            artifact_name: CheeseCloudTools-Linux-x64

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ matrix.python_arch || 'x64' }}
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: ğŸ”¨ æ‰§è¡Œæ‰“åŒ…
        run: python build_app.py --platform ${{ matrix.platform }}
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.platform }}/
          retention-days: 30

  # åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€ tag æ—¶ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: ğŸ“¦ æ‰“åŒ…ä¸º ZIP
        run: |
          cd artifacts
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done
      
      - name: ğŸš€ åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

